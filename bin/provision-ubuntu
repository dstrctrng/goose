#!/usr/bin/env bash

#/ NAME
#/     provision-ubuntu  - packer provisioning script

function remote_build {
  set -exfu; exec 2>&1

  echo ubuntu | sudo -S true
  container_build
}

function container_build {
  local prefix=""
  local sudoch="sudo -E aptitude"

  # package updates
  local tmp_apt_disable="$(mktemp -t XXXXXX)"
  cat > $tmp_apt_disable <<__EOF
APT::Install-Recommends "0";
__EOF
  sudo cp "$tmp_apt_disable" "$prefix/etc/apt/apt.conf.d/00DisableInstallRecommends"
  rm -f "$tmp_apt_disable"

  # sudoer permissions
  local tmp_sudo="$(mktemp -t XXXXXX)"
  cat > $tmp_sudo <<__EOF
ubuntu ALL=(ALL) NOPASSWD: ALL
__EOF
  sudo cp "$tmp_sudo" $prefix/etc/sudoers.d/90-cloud-init-users
  sudo chmod 0400 $prefix/etc/sudoers.d/90-cloud-init-users
  rm -f "$tmp_sudo"

  # allow vagrant ssh using insecure key
  sudo install -d -m 0700 $prefix/home/ubuntu/.ssh
  echo "ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA6NF8iallvQVp22WDkTkyrtvp9eWW6A8YVr+kz4TjGYe7gHzIw+niNltGEFHzD8+v1I2YJ6oXevct1YeS0o9HZyN1Q9qgCgzUFtdOKLv6IedplqoPkcmF0aYet2PkEDo3MlTBckFXPITAMzF8dJSIFo9D8HfdOV0IAdx4O7PtixWKn5y2hMNG0zQPyUecp4pzC6kivAIhyfHilFR61RGL+GPXQ2MWZWFYbAGjyiYJnAmCP3NOTd0jMZEnDkbUvxhMmBYSdETk1rRgm+R4LOzFUGaHqHDLKLX+FIPKcF96hrucXzcWyLbIbEgE98OHlnVYCzRdK8jlqm8tehUc9c9WhQ== vagrant insecure public key" | sudo tee $prefix/home/ubuntu/.ssh/authorized_keys
  sudo chmod 600 $prefix/home/ubuntu/.ssh/authorized_keys

  # create ubuntu user
  sudo chown -R ubuntu:ubuntu /home/ubuntu

  # cleanup
  sudo rm -rf /etc/udev/rules.d/70-persistent-net.rules /lib/udev/rules.d/75-persistent-net-generator.rules /dev/.udev /var/lib/dhcp3
  sudo mkdir -p /etc/udev/rules.d/70-persistent-net.rules
}

remote_build "$@"
